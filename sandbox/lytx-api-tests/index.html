<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lytx VIDEO API Tester</title>
    <style>
      :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
      body { margin: 16px; color: #111827; background: #f9fafb; }
      h1 { font-size: 20px; margin: 0 0 12px; }
      .card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
      input, textarea, select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; box-sizing: border-box; font-family: inherit; font-size: 14px; }
      textarea { min-height: 70px; resize: vertical; }
      .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
      .col-6 { grid-column: span 6; }
      .col-4 { grid-column: span 4; }
      .col-3 { grid-column: span 3; }
      .col-8 { grid-column: span 8; }
      .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #2563eb; color: #fff; border: 0; border-radius: 6px; cursor: pointer; font-weight: 600; }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn.secondary { background: #111827; }
      .muted { color: #6b7280; font-size: 12px; }
      .chips { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip { padding: 6px 10px; border-radius: 999px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-size: 12px; }
      pre { background: #0b1021; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; font-size: 12px; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body>
    <h1>Lytx VIDEO API Tester</h1>
    <div class="card">
      <div class="row">
        <div class="col-6">
          <label>Base URL</label>
          <input id="baseUrl" value="https://lytx-api.prod7.lv.lytx.com/video" />
          <div class="muted">Default is PROD7. Override only if your pod differs.</div>
        </div>
        <div class="col-6">
          <label>API Key (header: X-APIKey)</label>
          <input id="apiKey" type="password" placeholder="Enter your API key" />
          <div class="muted">Not stored. Used only for this page session.</div>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <div class="col-8">
          <label>Endpoint Path</label>
          <input id="path" value="/safety/events" />
        </div>
        <div class="col-4">
          <label>Method</label>
          <select id="method">
            <option>GET</option>
          </select>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <div class="col-6">
          <label>Query Params (key=value, one per line)</label>
          <textarea id="queryLines" placeholder="from=2021-03-16T00:00:00.000Z&#10;to=2021-03-17T00:00:00.000Z&#10;dateOption=lastUpdatedDate"></textarea>
        </div>
        <div class="col-6">
          <label>Options</label>
          <div style="display:flex; align-items:center; gap:10px; padding:8px 0;">
            <input id="useProxy" type="checkbox" />
            <span>Use local proxy (http://localhost:5717) to avoid CORS and hide key from browser requests.</span>
          </div>
          <div class="chips">
            <div class="chip" data-template="events">/safety/events (last 24h)</div>
            <div class="chip" data-template="eventsMeta">/safety/eventsWithMetadata (last 24h)</div>
            <div class="chip" data-template="statuses">/safety/events/statuses</div>
            <div class="chip" data-template="triggers">/safety/events/triggers</div>
            <div class="chip" data-template="vehicles">/vehicles</div>
          </div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="sendBtn" class="btn">Send Request</button>
        <button id="fillNowBtn" class="btn secondary">Fill Now (last 24h)</button>
        <span class="muted">Tip: enable proxy and run it with "npm run start-proxy" inside this folder.</span>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:8px;">
        <strong>Request (cURL)</strong>
      </div>
      <pre id="curl"><code># Will appear here after you send a request</code></pre>
    </div>

    <div class="card">
      <div style="margin-bottom:8px;"><strong>Response</strong> <span id="status" class="muted"></span></div>
      <pre id="output"><code>// Response JSON will be shown here</code></pre>
    </div>

    <script>
      function isoNowMinus(hours) {
        const d = new Date(Date.now() - hours * 3600 * 1000);
        return d.toISOString();
      }

      function setTemplate(name) {
        const pathEl = document.getElementById('path');
        const qEl = document.getElementById('queryLines');
        if (name === 'events') {
          pathEl.value = '/safety/events';
          qEl.value = `from=${isoNowMinus(24)}\nto=${new Date().toISOString()}\ndateOption=lastUpdatedDate\nlimit=50`;
        } else if (name === 'eventsMeta') {
          pathEl.value = '/safety/eventsWithMetadata';
          qEl.value = `from=${isoNowMinus(24)}\nto=${new Date().toISOString()}\ndateOption=lastUpdatedDate\nlimit=25`;
        } else if (name === 'statuses') {
          pathEl.value = '/safety/events/statuses';
          qEl.value = '';
        } else if (name === 'triggers') {
          pathEl.value = '/safety/events/triggers';
          qEl.value = '';
        } else if (name === 'vehicles') {
          pathEl.value = '/vehicles';
          qEl.value = 'PageSize=25';
        }
      }

      function parseQueryLines(text) {
        const params = new URLSearchParams();
        text.split(/\r?\n/).forEach(line => {
          const trimmed = line.trim();
          if (!trimmed) return;
          const eq = trimmed.indexOf('=');
          if (eq === -1) return;
          const key = trimmed.slice(0, eq).trim();
          const val = trimmed.slice(eq + 1).trim();
          params.append(key, val);
        });
        return params.toString();
      }

      function maskKey(k) {
        if (!k) return '';
        if (k.length <= 6) return '*'.repeat(k.length);
        return k.slice(0, 2) + '***' + k.slice(-2);
      }

      async function sendRequest() {
        const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
        const apiKey = document.getElementById('apiKey').value.trim();
        const method = document.getElementById('method').value;
        const path = document.getElementById('path').value.trim();
        const useProxy = document.getElementById('useProxy').checked;
        const query = parseQueryLines(document.getElementById('queryLines').value);

        const url = (useProxy ? 'http://localhost:5717' : baseUrl) + path + (query ? `?${query}` : '');
        const headers = { 'Accept': 'application/json' };
        if (useProxy) headers['x-apikey'] = apiKey; else headers['X-APIKey'] = apiKey;

        const curlHeader = useProxy ? `-H "x-apikey: ${maskKey(apiKey)}"` : `-H "X-APIKey: ${maskKey(apiKey)}"`;
        document.getElementById('curl').textContent = `curl -X ${method} ${curlHeader} "${url}"`;

        const out = document.getElementById('output');
        const statusEl = document.getElementById('status');
        out.textContent = '// Sending...';
        statusEl.textContent = '';

        try {
          const res = await fetch(url, { method, headers });
          statusEl.textContent = `Status: ${res.status}`;
          const text = await res.text();
          try {
            const json = JSON.parse(text);
            out.textContent = JSON.stringify(json, null, 2);
          } catch (e) {
            out.textContent = text || '// No content';
          }
        } catch (err) {
          out.textContent = String(err);
          statusEl.textContent = 'Request failed';
        }
      }

      document.getElementById('sendBtn').addEventListener('click', sendRequest);
      document.getElementById('fillNowBtn').addEventListener('click', () => setTemplate('events'));
      document.querySelectorAll('.chip').forEach(el => el.addEventListener('click', () => setTemplate(el.dataset.template)));

      // Prefill defaults for convenience on load
      setTemplate('events');
    </script>
  </body>
</html>

